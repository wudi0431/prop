$(function(){if(chartId==""||userId==""){return}CLB.init()});var CLB={socket:null,clientId:null,url:"",listenTime:"",unloaded:false,init:function(){var b=Math.random();var a=(b+new Date().getTime());this.clientId=a.toString(16).replace(".","");this.listenTime=time;this.startListen();window.onbeforeunload=function(){try{if(CLB.sending||CLB.messageQueue.length>0){return"您的修改尚未保存，如果离开，您的编辑可能会丢失！"}}catch(c){}CLB.unloaded=true}},connection:null,listenFlag:true,listen:function(a){if(this.listenFlag==false||CLB.connection!=null){return}CLB.connection=$.ajax({url:"/diagraming/listen",data:{clientId:CLB.clientId,userId:userId,name:userName,subject:chartId,listenTime:CLB.listenTime},type:"get",success:function(b){CLB.connection=null;CLB.onMessage(b.events);if(typeof b.onlineUsers!="undefined"){CLB.manageOnlineUsers(b.onlineUsers)}},error:function(b){CLB.connection=null;if(CLB.unloaded==false){if(a){a()}else{CLB.listen(function(){CLB.listenFlag=false})}}}})},startListen:function(){this.listenFlag=true;this.listen()},stopListen:function(){this.listenFlag=false;if(CLB.connection){CLB.connection.abort()}CLB.connection=null},sending:false,onlineStatus:"on",messageQueue:[],send:function(c){var b={userId:userId,clientId:CLB.clientId,subject:chartId};var a=$.extend(b,c);this.messageQueue.push(a);if(this.sending==false){this.doSend()}},sendErrorCount:0,localSaveCount:0,doSend:function(c){if(this.onlineStatus=="off"){this.messageQueue=[];var d=$(".diagram_title").text();localStorage["def_local_"+chartId]=JSON.stringify(des.model.topic);localStorage["title_local_"+chartId]=d;localStorage["version_local_"+chartId]=chartVersion+1;this.localSaveCount++;if(this.localSaveCount>=5){this.localSaveCount=0;this.localSaveCount=0;this.localToServer(function(){$("#saving_tip").text("所有更改已保存");CLB.online()})}return}var a;if(typeof c=="undefined"){if(this.messageQueue.length==0){return}a=this.messageQueue;this.messageQueue=[]}else{a=c}var b;if(typeof a!="string"){b=JSON.stringify(a)}else{b=a}this.sending=true;if(typeof c=="undefined"){$("#saving_tip").text("正在保存...")}$.ajax({url:"/mind/msg",data:{msgStr:b,ignore:"msgStr",chartId:chartId},cache:false,type:"post",timeout:15000,success:function(e){CLB.sending=false;CLB.sendErrorCount=0;if(typeof c=="undefined"){$("#saving_tip").text("所有更改已保存")}CLB.doSend();chartVersion=e.version},error:function(f){CLB.sendErrorCount++;if(CLB.sendErrorCount<=1){setTimeout(function(){CLB.doSend(a)},4000)}else{if(localStorage){CLB.offline()}else{CLB.showDisconnected()}}}})},sendDirectly:function(b,e){var d={userId:userId,clientId:CLB.clientId,subject:chartId};var c=$.extend(d,b);var a=JSON.stringify(c);$.ajax({url:"/diagraming/msg_directly",data:{msgStr:a,ignore:"msgStr",chartId:chartId},cache:false,type:"post",success:function(f){if(e){e(f)}}})},sendMsgDirectly:function(b,e){var d={userId:userId,clientId:CLB.clientId,subject:chartId};var c=$.extend(d,b);var a=JSON.stringify(c);$.ajax({url:"/mind/msg_directly",data:{msgStr:a,ignore:"msgStr",chartId:chartId},cache:false,type:"post",success:function(f){if(e){e(f)}}})},onMessage:function(g){for(var h=0;h<g.length;h++){var a=g[h];var e=a.action;if(e=="refresh"){CLB.listenTime=a.listenTime;CLB.listen()}else{if(e=="join"){if($("#chat_user_"+a.userId).length==0){$("#collaborators").append("<img id='chat_user_"+a.userId+"' src='"+a.photoUrl+"' class='' title='"+a.name+"'/>")}}else{if(e=="leave"){if(a.userId!=userId){$("#chat_user_"+a.userId).remove()}}else{if(e=="changeTitle"){if(a.clientId!=this.clientId){$(".header_title").text(a.title)}}else{if(e=="chat"){if(a.clientId!=this.clientId){this.appendChatMsg(a.name,a.message,true)}}else{if(e=="changeSchema"){if(a.clientId!=this.clientId){if(a.categories==""){Designer.setSchema([])}else{Designer.setSchema(a.categories.split(","))}}}else{if(e=="command"){if(a.clientId!=this.clientId){des.messageSource.receive(a.messages,a.userId);var j=a.messages[0];if(j!=null){var k=j.content,b=j.action,c;if(b=="create"){c=k.content[0]}else{if(b=="update"){c=k.updates[0]}else{if(b=="delete"){c=k.content[0];return}else{return}}}var f=$("#collaborators").children("img[id=chat_user_"+a.userId+"]");var d=$("#user_op_"+a.userId);if(d.length<=0){d=$("<div id='user_op_"+a.userId+"' class='collabration-user-tip'><img src='"+f.attr("src")+"'/><span class='username'>"+f.attr("title")+"</span><span class='useroperate'>正在修改...</span><span class='arrow'></span></div>").appendTo("body")}d.stop().animate({left:$(".tp_box#"+c.id).offset().left,top:$(".tp_box#"+c.id).offset().top-d.height()-15},200);d.fadeIn();$(".tp_box#"+c.id).addClass("collabration-user-oprating");window.setTimeout(function(){$(".tp_box#"+c.id).removeClass("collabration-user-oprating");d.fadeIn().remove()},6000)}}}else{if(e=="addHistory"){if(Dock.historyVersions!=null&&a.clientId!=this.clientId){Dock.loadHistorys()}}}}}}}}}}},offlineRemind:true,offline:function(){this.onlineStatus="off";this.sending=false;if(this.offlineRemind){UI.showTip("与服务器连接不稳定，文件暂时保存到本地，连接正常时会自动同步到服务器。<a href='javascript:' style='margin-left: 10px;color:#0080FF' onclick='CLB.notRemindOffline()'>不再提醒</a>","left")}CLB.doSend()},online:function(){UI.hideTip();this.onlineStatus="on";this.doSend()},notRemindOffline:function(){this.offlineRemind=false;UI.hideTip()},showDisconnected:function(){$("#disconnected").dlg({closable:false})},localToServer:function(c){var a=localStorage["def_local_"+chartId];var b=localStorage["title_local_"+chartId];if(!a){return}this.sending=true;$.ajax({url:"/diagraming/savelocal",data:{def:a,title:b,chartId:chartId,ignore:"def"},cache:false,type:"post",success:function(d){if(c){c(d)}CLB.sending=false;CLB.doSend();CLB.removeLocal()},error:function(){CLB.sending=false;CLB.doSend()}})},findLocal:function(){var a=false;if(localStorage&&localStorage["def_local_"+chartId]){var d=localStorage["def_local_"+chartId];var c=parseInt(localStorage["version_local_"+chartId]);var b=parseInt(localStorage["title_local_"+chartId]);if(c>=chartVersion){Designer.open(d);this.localToServer();a=true}else{this.removeLocal()}}return a},removeLocal:function(){localStorage.removeItem("def_local_"+chartId);localStorage.removeItem("title_local_"+chartId);localStorage.removeItem("version_local_"+chartId)},manageOnlineUsers:function(b){$("#collaborators").children().attr("class","");for(var c=0;c<b.length;c++){var a=b[c];if($("#chat_user_"+a.userId).length==0){$("#collaborators").append("<img id='chat_user_"+a.userId+"' src='"+a.photoUrl+"' title='"+a.name+"' title_pos='top'/>")}$("#chat_user_"+a.userId).attr("class","online")}$("#collaborators").children("img[class!=online]").remove()},showChatWin:function(){des.op.opArea="others";if($("#open_chat_btn").button("isSelected")){CLB.closeChatWin();return}$("#open_chat_btn").button("select");$("#chattingbox").css("left",$("#shape_panel").outerWidth()).show();$("#chatting_edit").focus().unbind().bind("keydown",function(a){if(a.keyCode==13){if($.trim($(this).val())==""){return}CLB.sendChatMsg();return false}});$("#chat_prompt").hide().text("0")},closeChatWin:function(){$("#chattingbox").hide();$("#open_chat_btn").button("unselect");des.op.opArea="designer"},sendChatMsg:function(){var b=$("#chatting_edit").val();if(b==""){$("#chatting_edit").focus();return}var a={action:"chat",message:b,name:userName};CLB.sendDirectly(a);this.appendChatMsg(userName,b,false);$("#chatting_edit").val("").focus()},appendChatMsg:function(c,d,b){d=des.utils.filterXss(d);d=d.replace(/\n/g,"<br/>");$("#chat_messages").append("<li><span>"+c+"</span>:&nbsp;"+d+"</li>");$("#chat_messages").scrollTop(9999999);if(b&&!$("#open_chat_btn").button("isSelected")){var a=parseInt($("#chat_prompt").text())+1;$("#chat_prompt").show().text(a).animate({top:"-15px"},200).animate({top:"-9px"},200)}},setConfig:function(b,a){$.ajax({url:"/diagraming/config",data:{field:b,value:a},cache:false,type:"post",success:function(){}})}};